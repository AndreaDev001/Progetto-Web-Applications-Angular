
<!-- report modal-->

<ng-template #reportModal let-modal>
  <div class = "d-block whitesmoke-text">
    <div class="modal-header secondary">
      <h4 class="modal-title" id="modal-basic-title">Report Form</h4>
      <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="closeReportReview(false)"></button>
    </div>
    <div class="modal-body background-secondary-color">
      <label for="reasonTextArea">Report reason:</label>
      <textarea class="form-control secondary whitesmoke-text" id="reasonTextArea" [formControl]="reportFormControl" rows="3"></textarea>
      <p *ngIf="reportFormControl.invalid && (reportFormControl.dirty || reportFormControl.touched)" style="color: var(--danger);">Report reason is required</p>
    </div>
    <div class="modal-footer background-secondary-color" style="border: 0">
      <button class="btn button button-primary" type="button" (click)="closeReportReview(false)" >CLOSE</button>
      <button class="btn button button-danger" [disabled]="reportFormControl.invalid" type="submit" (click)="closeReportReview(true)">CONFIRM</button>
    </div>
  </div>
</ng-template>

<!-- review section-->
<div class="banner text-white" style="background-image: linear-gradient(0deg, var(--background-color) 8%, rgba(25, 25, 25,0.4) 100%), url('{{game.image}}');">

  <div class="d-flex" *ngIf="!this.isNewReview()">
    <app-feedback [feedback]="this.review" [target]="this"></app-feedback>
    <button class="btn button button-primary" (click)="openReportReview(reportModal)">Report</button>
    <button *ngIf="this.review.utente !== undefined && this.review.utente === this.loggedUser?.username" class="btn button button-danger" (click)="deleteReviewPrompt()">Delete Review</button>
    <h4 class="text-muted">{{this.review.data | date:'EEEE, MMMM d, y, h:mm:ss a'}}</h4>
  </div>
  <div class="content">
    <section id="review_section" class="d-flex flex-column justify-content-center align-items-center">
      <form class="w-100" (ngSubmit)="(isNewReview() ? publishReview() : editReview())" [formGroup]="form" *ngIf="this.isEditMode; else htmlReview">

        <div class="form-group">
          <label for="exampleFormControlInput1">Title</label>
          <input maxlength="40" formControlName="titolo" type="text" class="whitesmoke-text form-control background-secondary-color" placeholder="titolo" >
          <div *ngIf="form.controls.titolo.errors  && (form.dirty || form.touched)" class="text-danger">
            Title is required
          </div>
        </div>

        <!-- editor form -->
        <div *ngIf="form.hasError('required', 'title')">EEEE</div>
        <div class="NgxEditor__Wrapper">
          <ngx-editor-menu [editor]="editor" [toolbar]="toolbar"> </ngx-editor-menu>
          <ngx-editor placeholder="write review..." [editor]="editor" formControlName="contenuto"> </ngx-editor>
        </div>
        <div *ngIf="form.invalid && (form.dirty || form.touched)" class="text-danger">
          <div *ngIf="form.hasError('minlength', 'contenuto')">
            Minimum Characters Required {{form.getError("minlength", "contenuto")?.actualLength}} / {{form.getError("minlength", "contenuto")?.requiredLength}}
            </div>
          <div *ngIf="form.hasError('required', 'contenuto')">
              Review is required
          </div>
        </div>

        <select class="form-select form-select-sm background-secondary-color whitesmoke-text" formControlName="voto">
          <option *ngFor="let vote of votes" [value]="vote">{{vote}}/10</option>
        </select>

        <button class="btn button button-primary mt-2" style="text-align: center;"  type="submit" [disabled]="form.invalid || !form.dirty || this.publishReviewStatus.isLoading">{{!isNewReview() ? 'SUBMIT' : 'PUBLISH' }}</button>
      </form>


      <ng-template #htmlReview>
      <h1>{{review.titolo}}</h1>
      <div class="w-100" id="review" [innerHtml]="sanitizer.bypassSecurityTrustHtml(this.review.contenuto)"></div>
      <h1>{{review.voto}}/10</h1>
      </ng-template>

      <button class="btn button button-secondary" *ngIf="!this.isNewReview() && loggedUser !== null && loggedUser?.username === review.utente" [disabled]="this.publishReviewStatus.isLoading" (click)="this.setEditMode(!this.isEditMode)">{{!this.isEditMode ? "EDIT" : "DISCARD CHANGES"}}</button>


    </section >
    <section class="" *ngIf="!this.isNewReview()" [immediateCheck]="true" infiniteScroll (scrolled)="loadNewComments()" id="commentsSection">


      <div>
        <h3>Comment Section</h3>
        <section *ngIf="this.loggedUser !== null && this.loggedUser !== undefined; else authenticationText">
          <textarea [formControl]="newCommentFormControl" placeholder="Write comment..." class="w-100 ny-4 background-secondary-color whitesmoke-text" autosize [minRows]="1" [maxRows]="15" style="resize: none;border: unset;"></textarea>
          <button class="btn button button-primary" [disabled]="this.addCommentStatus.isLoading || newCommentFormControl.invalid" (click)="addComment()">PUBBLICA</button>
        </section>
      </div>
      <ng-template #authenticationText>
        <h5>To comment you must be <a href="http://localhost:8080/login">logged in</a></h5>
      </ng-template>
      <app-comment *ngFor="let comment of comments" [comment]="comment" [loggedUser]="this.loggedUser" (onDelete)="deleteComment($event)"></app-comment>
    </section>





</div>


